using autoconf

intf_libs = # Interface dependencies.
impl_libs = # Implementation dependencies.

include ../libconfig/
impl_libs += ../libconfig/lib{config}

cpu = [string] $c.target.cpu
tgt_win32 = [bool] ($c.target.system == 'win32-msvc')
tgt_macos = [bool] ($c.target.system == 'darwin')

HEADERS = adler32.h                                                     \
          aes.h                                                         \
          aes_ctr.h                                                     \
          ambient_viewing_environment.h                                 \
          attributes.h                                                  \
          audio_fifo.h                                                  \
          avassert.h                                                    \
          avstring.h                                                    \
          avutil.h                                                      \
          base64.h                                                      \
          blowfish.h                                                    \
          bprint.h                                                      \
          bswap.h                                                       \
          buffer.h                                                      \
          cast5.h                                                       \
          camellia.h                                                    \
          channel_layout.h                                              \
          common.h                                                      \
          cpu.h                                                         \
          crc.h                                                         \
          csp.h                                                         \
          des.h                                                         \
          detection_bbox.h                                              \
          dict.h                                                        \
          display.h                                                     \
          dovi_meta.h                                                   \
          downmix_info.h                                                \
          encryption_info.h                                             \
          error.h                                                       \
          eval.h                                                        \
          executor.h                                                    \
          fifo.h                                                        \
          file.h                                                        \
          frame.h                                                       \
          hash.h                                                        \
          hdr_dynamic_metadata.h                                        \
          hdr_dynamic_vivid_metadata.h                                  \
          hmac.h                                                        \
          hwcontext.h                                                   \
          hwcontext_cuda.h                                              \
          hwcontext_d3d11va.h                                           \
          hwcontext_d3d12va.h                                           \
          hwcontext_drm.h                                               \
          hwcontext_dxva2.h                                             \
          hwcontext_qsv.h                                               \
          hwcontext_mediacodec.h                                        \
          hwcontext_opencl.h                                            \
          hwcontext_vaapi.h                                             \
          hwcontext_videotoolbox.h                                      \
          hwcontext_vdpau.h                                             \
          hwcontext_vulkan.h                                            \
          iamf.h                                                        \
          imgutils.h                                                    \
          intfloat.h                                                    \
          intreadwrite.h                                                \
          lfg.h                                                         \
          log.h                                                         \
          lzo.h                                                         \
          macros.h                                                      \
          mathematics.h                                                 \
          mastering_display_metadata.h                                  \
          md5.h                                                         \
          mem.h                                                         \
          motion_vector.h                                               \
          murmur3.h                                                     \
          opt.h                                                         \
          parseutils.h                                                  \
          pixdesc.h                                                     \
          pixelutils.h                                                  \
          pixfmt.h                                                      \
          random_seed.h                                                 \
          rc4.h                                                         \
          rational.h                                                    \
          replaygain.h                                                  \
          ripemd.h                                                      \
          samplefmt.h                                                   \
          sha.h                                                         \
          sha512.h                                                      \
          spherical.h                                                   \
          stereo3d.h                                                    \
          threadmessage.h                                               \
          time.h                                                        \
          timecode.h                                                    \
          timestamp.h                                                   \
          tree.h                                                        \
          twofish.h                                                     \
          uuid.h                                                        \
          version.h                                                     \
          video_enc_params.h                                            \
          xtea.h                                                        \
          tea.h                                                         \
          tx.h                                                          \
          film_grain_params.h                                           \
          video_hint.h

ARCH_HEADERS = bswap.h                                                  \
               intmath.h                                                \
               intreadwrite.h                                           \
               timer.h                                                  \

BUILT_HEADERS = avconfig.h                                              \
                ffversion.h

OBJS = adler32.c                                                        \
       aes.c                                                            \
       aes_ctr.c                                                        \
       ambient_viewing_environment.c                                    \
       audio_fifo.c                                                     \
       avstring.c                                                       \
       avsscanf.c                                                       \
       base64.c                                                         \
       blowfish.c                                                       \
       bprint.c                                                         \
       buffer.c                                                         \
       cast5.c                                                          \
       camellia.c                                                       \
       channel_layout.c                                                 \
       cpu.c                                                            \
       crc.c                                                            \
       csp.c                                                            \
       des.c                                                            \
       detection_bbox.c                                                 \
       dict.c                                                           \
       display.c                                                        \
       dovi_meta.c                                                      \
       downmix_info.c                                                   \
       encryption_info.c                                                \
       error.c                                                          \
       eval.c                                                           \
       executor.c                                                       \
       fifo.c                                                           \
       file.c                                                           \
       file_open.c                                                      \
       float_dsp.c                                                      \
       fixed_dsp.c                                                      \
       frame.c                                                          \
       hash.c                                                           \
       hdr_dynamic_metadata.c                                           \
       hdr_dynamic_vivid_metadata.c                                     \
       hmac.c                                                           \
       hwcontext.c                                                      \
       iamf.c                                                           \
       imgutils.c                                                       \
       integer.c                                                        \
       intmath.c                                                        \
       lfg.c                                                            \
       lls.c                                                            \
       log.c                                                            \
       log2_tab.c                                                       \
       lzo.c                                                            \
       mathematics.c                                                    \
       mastering_display_metadata.c                                     \
       md5.c                                                            \
       mem.c                                                            \
       murmur3.c                                                        \
       opt.c                                                            \
       parseutils.c                                                     \
       pixdesc.c                                                        \
       pixelutils.c                                                     \
       random_seed.c                                                    \
       rational.c                                                       \
       reverse.c                                                        \
       rc4.c                                                            \
       ripemd.c                                                         \
       samplefmt.c                                                      \
       sha.c                                                            \
       sha512.c                                                         \
       slicethread.c                                                    \
       spherical.c                                                      \
       stereo3d.c                                                       \
       threadmessage.c                                                  \
       time.c                                                           \
       timecode.c                                                       \
       timestamp.c                                                      \
       tree.c                                                           \
       twofish.c                                                        \
       utils.c                                                          \
       xga_font_data.c                                                  \
       xtea.c                                                           \
       tea.c                                                            \
       tx.c                                                             \
       tx_float.c                                                       \
       tx_double.c                                                      \
       tx_int32.c                                                       \
       uuid.c                                                           \
       version.c                                                        \
       video_enc_params.c                                               \
       video_hint.c                                                     \
       film_grain_params.c \
       hwcontext_d3d11va.c # <---------- temp! should be conditional

lib{avutil}: libul{avutil}: \
               libavutil/h{$HEADERS} \
               libavutil/h{$ARCH_HEADERS} \
               libavutil/c{$OBJS} \
               libavutil/h{avconfig ffversion} \
               $impl_libs $intf_libs

# Architecture specific source
# libavutils/aarch64
# libavutils/arm
# libavutils/avr32
# libavutils/loongarch
# libavutils/mips
# libavutils/ppc
# libavutils/riscv
# libavutils/x86
libul{avutil}: libavutil/arm/{h c}{**}: include = ($cpu == 'arm')
libul{avutil}: libavutil/aarch64/{h c}{**}: include = ($cpu == 'aarch64')
libul{avutil}: libavutil/x86/{h c}{**}: include = $regex.match($cpu, 'i[3-6]86')

# OS specific source
# Win32
libul{avutil}: \
  compat/windows/{h c}{*} \
  compat/{h c}{w32*} \
  : include = $tgt_win32

# GCC

# MacOS
libul{avutil}: libavutil/{h c}{macos_*}: include = $tgt_macos

libavutil/h{avconfig}: in{avconfig}
{
  autoconf.prefix = AV_
}

[rule_hint=version.in] \
libavutil/h{ffversion}: in{ffversion} $src_root/manifest

# Build options.
#
out_pfx = [dir_path] $out_root/src/
src_pfx = [dir_path] $src_root/src/

c.poptions =+ "-I$out_pfx" "-I$src_pfx" -DBUILDING_avutil
objs{**}: c.poptions =+ -DCONFIG_SHARED

# System libraries
sys_libs =
switch $c.target.class, $c.target.system
{
  case 'windows', 'win32-msvc'
    sys_libs += bcrypt.lib
  case 'windows', 'mingw32'
    sys_libs += -lbcrypt
}
c.libs += $sys_libs

# <stdatomic.h> compatibility
use_compat_atomics = [bool] true # ($c.find_system_header("stdatomic.h") == [null]) # NEED TO CHECK $c.std <= 17 (but handle case when not defined)
if ($use_compat_atomics)
{
  switch ($c.target.system)
  {
    case 'win32-msvc'
    {
      c.coptions += -wd4018 -wd4146 -wd4244 -wd4305 -wd4554 -wd4133 -wd4333
      c.poptions += "-I$src_pfx/compat/atomics/win32/" \
                    -DWIN32_LEAN_AND_MEAN -D_USE_MATH_DEFINES -D_CRT_SECURE_NO_WARNINGS -D_CRT_NONSTDC_NO_WARNINGS
      lib{avutil}: c.export.poptions += "-I$src_pfx/compat/atomics/win32/"
    }
  }
}

libs{avutil}: def{avutil}: include = ($c.target.system == 'win32-msvc')
def{avutil}: libul{avutil}

if ($c.target.system == 'mingw32')
  c.loptions += -Wl,--export-all-symbols

# Export options.
#
lib{avutil}:
{
  libavutil.pixelutils = $config.libavutil.pixelutils
  c.export.poptions += "-I$out_pfx" "-I$src_pfx" -DHAVE_AV_CONFIG_H
  c.export.libs = $intf_libs $sys_libs
}
# workaround: <libavutil/md5.c> doesn't prefix with AV_
libavutil/obj{md5}:
{
  c.poptions =+ -DHAVE_FAST_UNALIGNED=1
}

# For pre-releases use the complete version to make sure they cannot
# be used in place of another pre-release or the final version. See
# the version module for details on the version.* variable values.
#
if $version.pre_release
  lib{avutil}: bin.lib.version = "-$version.project_id"
else
  lib{avutil}: bin.lib.version = "-$version.major.$version.minor"

# Install recreating subdirectories.
#
h{*}:
{
  install         = include/
  install.subdirs = true
}
